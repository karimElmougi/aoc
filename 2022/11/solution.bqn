#! /usr/bin/env BQN

âŸ¨Split, ToNum, PartitionâŸ© â† â€¢Import "../../utils.bqn"

input â† â€¢FLines "input.txt"
# input â† âŸ¨
#     "Monkey 0:"
#     "  Starting items: 79, 98"
#     "  Operation: new = old * 19"
#     "  Test: divisible by 23"
#     "    If true: throw to monkey 2"
#     "    If false: throw to monkey 3"
#     ""
#     "Monkey 1:"
#     "  Starting items: 54, 65, 75, 74"
#     "  Operation: new = old + 6"
#     "  Test: divisible by 19"
#     "    If true: throw to monkey 2"
#     "    If false: throw to monkey 0"
#     ""
#     "Monkey 2:"
#     "  Starting items: 79, 60, 97"
#     "  Operation: new = old * old"
#     "  Test: divisible by 13"
#     "    If true: throw to monkey 1"
#     "    If false: throw to monkey 3"
#     ""
#     "Monkey 3:"
#     "  Starting items: 74"
#     "  Operation: new = old + 3"
#     "  Test: divisible by 17"
#     "    If true: throw to monkey 0"
#     "    If false: throw to monkey 1"
# âŸ©

ParseOp â† (âŠ‘ '+'â€¿'*'âŠ¸âŠ)âŠ‘+â€¿Ã— {ğ”½}
ToFn â† { opâ€¿arg â† ' 'âŠ¸Split ğ•© â‹„ (ğ•© â‰¡ "* old") âŠ‘ ((ParseOp op)âŸœ(ToNum arg))â€¿(â‹†âŸœ2) }
Parse â† ((ToNumÂ¨)âˆ˜(", "âŠ¸Split)âˆ˜(18âŠ¸â†“))â€¿(ToFn 23âŠ¸â†“)â€¿(ToNum 21âŠ¸â†“)â€¿(ToNum 29âŠ¸â†“)â€¿(ToNum 30âŠ¸â†“) {ğ• ğ•©}Â¨ 1âŠ¸â†“

input â†© ParseÂ¨ ((0âŠ¸â‰ )âˆ˜â‰ Â¨)âŠ¸Partition input

_Run â† {Fn _ğ•£ rounds:
    monkeys â† âŸ¨âŸ©
    monkeys â†© {ğ•Š itemsâ€¿opâ€¿divâ€¿trueâ€¿false:
        Op â†© op {ğ”½}
        inspect â‡ 0

        Push â‡ {items â†© itemsâˆ¾ğ•©}
        Run â‡ {ğ•¤
            { 
                worry â† Fn Op ğ•©
                is_divisible â† (0âŠ¸= divâŠ¸|) worry
                monkey â† { is_divisible ? true ; false} âŠ‘ monkeys
                monkey.Push worry 
            }Â¨ items
            inspect â†© inspect + â‰ items
            items â†© âŸ¨âŸ©
        }
    }Â¨ input
    {ğ•Š ğ•©: {{ğ•©.Run@}Â¨ monkeys}}Â¨ â†•rounds
    monkeys
}

max_worry â† Ã—Â´ (2âŠ¸âŠ‘âŠ¢)Â¨ input
â€¢ShowÂ¨ { Ã—Â´ 2âŠ¸â†‘ âˆ¨ {ğ•©.inspect}Â¨ ğ•© }Â¨ ((âŒŠ Ã·âŸœ3)_Run 20)â€¿((max_worryâŠ¸|)_Run 10000)